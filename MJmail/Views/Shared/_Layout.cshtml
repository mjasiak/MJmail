<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - My ASP.NET Application</title>
    <link href="~/Style/Content/navbar-fixed-side.css" rel="stylesheet" />
    <link href="~/Style/Content/jquery.scrollbar.css" rel="stylesheet" />
    <link href="~/Style/Content/awesome-bootstrap-checkbox.css" rel="stylesheet" />
    @Styles.Render("~/Content/css")
    @Scripts.Render("~/bundles/modernizr")
    @Scripts.Render("~/bundles/jquery")
    <script src="//cdn.tinymce.com/4/tinymce.min.js"></script>
    <script>tinymce.init({ selector:'textarea' });</script>
    <script src="~/Style/Scripts/messagescontroller.js"></script>
    <script src="~/Style/Scripts/ClockJS.js"></script>
    <script src="https://use.fontawesome.com/11a80ab1b5.js"></script>
    <script src="~/Style/Scripts/jquery.scrollbar.js"></script>
    <script src="~/Style/Scripts/jquery.signalR-2.2.1.js"></script>
    <script src="~/signalr/hubs"></script>
    <script>
        jQuery(document).ready(function () {
            jQuery('.scrollbar-outer').scrollbar();
        });
    </script>
    <script>
        $(function () {

            setScreen(false);

            // Declare a proxy to reference the hub. 
            var chatHub = $.connection.chatHub;

            registerClientMethods(chatHub);

            // Start Hub
            $.connection.hub.start().done(function () {

                registerEvents(chatHub)

            });

        });

        function setScreen(isLogin) {

            if (!isLogin) {

                $("#loggedName").hide();
                $(".chat_menu-people").hide();
                $(".loginDialog").show();
            }
            else {

                $("#loggedName").show();
                $(".chat_menu-people").show();
                $(".loginDialog").hide();
            }

        }

        function registerEvents(chatHub) {

            $("#login").change(function () {
                var name = $("#login").val();
                if (name.length > 0) {
                    chatHub.server.connect(name);
                }
                else {
                    alert("Please enter name");
                }

            });
        }

        function registerClientMethods(chatHub) {
            //chatHub.client.onConnected = function (id, userName, allUsers, messages) {
            chatHub.client.onConnected = function(id,userName, allUsers){

                setScreen(true);
                
                $('#loggedID').val(id);
                $('#loggedName').text(userName);
                //$('#spanUser').html(userName);

                // Add All Users
                for (i = 0; i < allUsers.length; i++) {

                    AddUser(chatHub, allUsers[i].ConnectionId, allUsers[i].UserName);
                }

                //// Add Existing Messages
                //for (i = 0; i < messages.length; i++) {

                //    AddMessage(messages[i].UserName, messages[i].Message);
                //}
            }

            chatHub.client.onNewUserConnected = function (id,userName) {
                AddUser(chatHub, id, userName);
            }
        }

        function AddUser(chatHub, id, name) {

            var userId = $('#loggedID').val();

            var code = "";

            if (userId == id) {

            }
            else {

                code = $('<a id="' + id + '" class="user" >' + name + '<a>');

                //$(code).dblclick(function () {

                //    var id = $(this).attr('id');

                //    if (userId != id)
                //        OpenPrivateChatWindow(chatHub, id, name);

                //});
            }

            $(".chat_menu-peoplelist").append(code);
        }
    </script>
</head>
<body>
    <div class="site-wrapper">
        <div class="site-wrapper-inner">
            <div class="col-xs-2 col-md-2 fit-size-toscreen navigation-container " style="background-color:#181818;">
                <div class="text-center" id="clock"></div>
                <div class="text-center">
                    <button class="btn btn-danger" id="new_button">WRITE</button>
                </div>
                <div class="menu-container">
                    <ul class="menu-nav">
                        <li>@Html.ActionLink("Inbox", "Inbox", "Messages")</li>
                        <li>@Html.ActionLink("Sent", "Outbox", "Messages")</li>
                    </ul>
                </div>                
            </div>
            <div class="col-xs-10 col-md-10 fit-size-toscreen" id="MailBox">
                @RenderBody()
            </div>
            <div class="col-xs-3 col-md-3 fit-size-toscreen nopadding" id="chat">
                <div class="chat_menu fit-size-toscreen">
                    <div class="chat_menu-header">
                        <h3>Chat</h3>
                    </div>
                    <div class="chat_menu-nav">
                        <h3 id="loggedName"></h3>
                        <div class="loginDialog">
                            <form>
                                <div class="form-group">
                                    <label for="login">Your name:</label>
                                    <input type="text" class="form-control" id="login">
                                </div>
                                @*<button type="submit" class="btn btn-default">Zaloguj</button>*@
                            </form>
                        </div>
                    </div>
                    <div class="chat_menu-people">
                        <h3>CONTACTS</h3>
                        <div class="chat_menu-peoplelist">

                        </div>                      
                    </div>  
                </div>                               
            </div>
        </div>
    </div>
    <input id="loggedID" type="hidden" />
    <div id="Modal" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <div class="modal-header">
                <span class="close">x</span>
                <h2 class="text-center">New message</h2>
            </div>
            <div class="modal-body">
                <form id="new_message">
                    <div class="form-group">
                        <label for="text">Title</label>
                        <input type="text" class="form-control" name="MailTitle"/>
                    </div>
                    <div class="form-group">
                        <label for="email">To</label>
                        <input type="email" class="form-control" name="MailTo" />
                    </div>
                    <div class="form-group">
                        <label for="content">Content</label>
                        <textarea class="form-control" rows="5" name="MailContent"></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger">Send</button>
                </form>
            </div>          
        </div>

    </div>        
    @Scripts.Render("~/bundles/bootstrap")
    @RenderSection("scripts", required: false)
</body>
</html>
